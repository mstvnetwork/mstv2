<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MSTV Live Scheduler</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }
    video {
      width: 90%;
      max-width: 800px;
      height: auto;
      margin-top: 20px;
      border: 4px solid gold;
      border-radius: 12px;
    }
    #now-playing {
      margin-top: 10px;
      font-size: 1.2em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>MSTV Live Channel</h1>
  <video id="video" controls autoplay></video>
  <div id="now-playing">Loading...</div>

  <script>
    const scheduleUrl = "https://raw.githubusercontent.com/mstvnetwork/mstv2/main/schedule.json"; // <-- Your JSON path
    const video = document.getElementById('video');
    const nowPlaying = document.getElementById('now-playing');

    function getCurrentTimeHHMM() {
      const now = new Date();  // Can adjust to Melbourne with UTC+10 if needed
      let hh = String(now.getHours()).padStart(2, '0');
      let mm = String(now.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
    }

    function findCurrentSlot(schedule) {
      const nowTime = getCurrentTimeHHMM();
      for (let i = 0; i < schedule.length; i++) {
        const slot = schedule[i];
        const [hh, mm] = slot.start.split(":").map(Number);
        const slotStart = new Date();
        slotStart.setHours(hh, mm, 0, 0);
        const slotEnd = new Date(slotStart.getTime() + slot.duration * 60000);

        const now = new Date();
        if (now >= slotStart && now < slotEnd) {
          return slot;
        }
      }
      return null;
    }

    function playHLS(url) {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play();
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.play();
      } else {
        nowPlaying.innerText = "Your browser does not support HLS playback.";
      }
    }

    fetch(scheduleUrl)
      .then(res => res.json())
      .then(schedule => {
        const slot = findCurrentSlot(schedule);
        if (slot) {
          nowPlaying.innerText = `Now Playing: ${slot.title || "Live Stream"}`;
          playHLS(slot.url);
        } else {
          nowPlaying.innerText = "Off Air â€” No scheduled content";
        }
      })
      .catch(err => {
        console.error("Error loading schedule:", err);
        nowPlaying.innerText = "Failed to load schedule.";
      });
  </script>
</body>
</html>
