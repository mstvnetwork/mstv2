<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MSTV Auto-Synced Channel</title>
  <style>
    body { margin: 0; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: white; font-family: sans-serif; }
    #player-container { position: relative; width: 90%; max-width: 800px; aspect-ratio: 16/9; background: #111; border: 3px solid gold; border-radius: 12px; overflow: hidden; }
    video, iframe { width: 100%; height: 100%; }
    #muteBtn {
      position: absolute; bottom: 10px; right: 10px;
      background: rgba(0,0,0,0.6); border: none; color: white;
      padding: 10px; font-size: 18px; border-radius: 50%;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>MSTV Network Channel</h2>
  <div id="player-container">
    <video id="video" controls playsinline style="display: none;"></video>
    <iframe id="iframe" frameborder="0" allowfullscreen allow="autoplay" style="display: none;"></iframe>
    <button id="muteBtn">ðŸ”‡</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById("video");
    const iframe = document.getElementById("iframe");
    const muteBtn = document.getElementById("muteBtn");
    let hls, isMuted = true;

    function getChannelNumber() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("ch") || "1";
    }

    function getCurrentTimeSeconds() {
      const now = new Date();
      return (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();
    }

    function loadMuteState() {
      return localStorage.getItem("isMuted") === "false" ? false : true;
    }

    function saveMuteState(state) {
      localStorage.setItem("isMuted", state);
    }

    function updateMuteUI() {
      muteBtn.textContent = isMuted ? "ðŸ”‡" : "ðŸ”Š";
      video.muted = isMuted;
      video.volume = isMuted ? 0 : 1;
    }

    muteBtn.addEventListener("click", () => {
      isMuted = !isMuted;
      saveMuteState(isMuted);
      updateMuteUI();
      if (!isMuted) video.play().catch(() => {});
    });

    async function loadChannel() {
      const channelNumber = getChannelNumber();
      const res = await fetch("channels.json");
      const data = await res.json();
      const urls = data["ch" + channelNumber];

      if (!urls || urls.length === 0) {
        alert("Channel not found or has no URLs");
        return;
      }

      const elapsed = getCurrentTimeSeconds();

      let loaded = false;

      for (let url of urls) {
        if (url.includes("youtube.com") || url.includes("youtu.be")) {
          video.style.display = "none";
          iframe.style.display = "block";
          iframe.src = url + (url.includes("?") ? "&" : "?") + "autoplay=1&mute=1";
          loaded = true;
          break;
        }

        if (url.endsWith(".mp4")) {
          iframe.style.display = "none";
          video.style.display = "block";
          video.src = url;
          video.currentTime = elapsed % 300; // Sync assuming 5min duration
          await video.play().catch(() => {});
          loaded = true;
          break;
        }

        if (url.endsWith(".m3u8")) {
          if (Hls.isSupported()) {
            iframe.style.display = "none";
            video.style.display = "block";
            if (hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
              const isLive = hls.levels[0].details.live;

              if (!isLive) {
                const duration = hls.levels[0].details.totalduration;
                const seekTime = elapsed % duration;
                video.currentTime = seekTime;
              }

              video.play().catch(() => {});
            });

            loaded = true;
            break;
          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.play().catch(() => {});
            loaded = true;
            break;
          }
        }
      }

      if (!loaded) alert("No supported video format found.");
    }

    // On Load
    (async () => {
      isMuted = true; // Force muted on load for autoplay
      saveMuteState(isMuted);
      updateMuteUI();
      await loadChannel();
    })();
  </script>
</body>
</html>
