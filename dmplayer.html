<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MSTV Channel Player</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #video-container {
      position: relative;
      width: 90vw;
      max-width: 960px;
      aspect-ratio: 16/9;
      background: #000;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      background: black;
    }
    #speaker-icon {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
    }
    #speaker-icon::before {
      content: "ðŸ”‡";
      font-size: 20px;
    }
    #speaker-icon.unmuted::before {
      content: "ðŸ”Š";
    }
  </style>
</head>
<body>
  <div id="video-container">
    <video id="video" playsinline muted autoplay></video>
    <div id="speaker-icon"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById("video");
    const speaker = document.getElementById("speaker-icon");
    const channelId = parseInt(new URLSearchParams(window.location.search).get("ch")) || 1;
    const scheduleURL = "https://raw.githubusercontent.com/mstvnetwork/mstv2/main/schedule.json";
    let hls;

    function saveVolumeState(isUnmuted) {
      localStorage.setItem("mstv_unmuted", isUnmuted ? "1" : "0");
    }

    function restoreVolumeState() {
      const saved = localStorage.getItem("mstv_unmuted");
      return saved === "1";
    }

    function updateSpeakerIcon(isUnmuted) {
      speaker.classList.toggle("unmuted", isUnmuted);
    }

    async function loadScheduleAndPlay() {
      const res = await fetch(scheduleURL);
      const channels = await res.json();
      const channel = channels[channelId - 1];
      if (!channel) {
        console.error("Channel not found");
        return;
      }

      const playlist = channel.playlist;
      const now = new Date();
      const secondsSinceMidnight = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      const totalDuration = playlist.reduce((sum, item) => sum + item.duration, 0);
      const timeInLoop = secondsSinceMidnight % totalDuration;

      let currentIndex = 0;
      let offset = 0;

      for (let i = 0; i < playlist.length; i++) {
        const dur = playlist[i].duration;
        if (offset + dur > timeInLoop) {
          currentIndex = i;
          break;
        }
        offset += dur;
      }

      const currentItem = playlist[currentIndex];
      const playOffset = timeInLoop - offset;

      playVideo(currentItem.url, playOffset);
    }

    function playVideo(url, startOffset = 0) {
      if (hls) {
        hls.destroy();
      }
      video.pause();
      video.removeAttribute('src');
      video.load();

      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          video.currentTime = startOffset;
          video.play().catch(() => {});
        });
        hls.on(Hls.Events.ERROR, function(event, data) {
          console.warn("HLS.js error", data);
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          video.currentTime = startOffset;
          video.play().catch(() => {});
        });
      } else {
        console.error("HLS not supported");
      }
    }

    speaker.addEventListener("click", () => {
      const willUnmute = video.muted;
      video.muted = !willUnmute;
      saveVolumeState(willUnmute);
      updateSpeakerIcon(willUnmute);
    });

    window.addEventListener("load", () => {
      const wasUnmuted = restoreVolumeState();
      video.muted = !wasUnmuted;
      updateSpeakerIcon(wasUnmuted);
      loadScheduleAndPlay();
    });
  </script>
</body>
</html>
