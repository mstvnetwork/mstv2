<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MSTV Channel Player</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
    }
    #player-container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    #video-wrapper {
      position: relative;
    }
    video {
      width: 100%;
      height: 450px;
      background: black;
    }
    #speaker-icon {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Speaker_Icon_Mute.svg/48px-Speaker_Icon_Mute.svg.png') center/contain no-repeat;
      cursor: pointer;
      z-index: 999;
    }
    #speaker-icon.unmuted {
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Speaker_Icon.svg/48px-Speaker_Icon.svg.png');
    }
    #now-playing {
      margin-top: 10px;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <div id="player-container">
    <div id="video-wrapper">
      <video id="video" autoplay muted playsinline></video>
      <div id="speaker-icon" title="Unmute"></div>
    </div>
    <div id="now-playing">Loading...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById("video");
    const speaker = document.getElementById("speaker-icon");
    let hls;
    let unmuted = false;
    let currentUrl = "";

    function getChannelIndex() {
      const params = new URLSearchParams(window.location.search);
      return parseInt(params.get("ch") || "1", 10) - 1;
    }

    function getCurrentSeconds() {
      const now = new Date();
      return (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();
    }

    async function loadSchedule() {
      const res = await fetch("https://raw.githubusercontent.com/mstvnetwork/mstv2/main/schedule.json");
      const data = await res.json();
      const chIndex = getChannelIndex();
      const channel = data[chIndex];
      if (!channel) {
        document.getElementById("now-playing").textContent = "Channel not found";
        return;
      }
      document.title = channel.name;
      document.getElementById("now-playing").textContent = `Now Playing: ${channel.name}`;
      playLoopingSchedule(channel.playlist);
    }

    function playLoopingSchedule(playlist) {
      const totalDuration = playlist.reduce((sum, item) => sum + item.duration, 0);
      const nowSec = getCurrentSeconds();
      const loopedSec = nowSec % totalDuration;

      let elapsed = 0;
      let selected, offset = 0;

      for (const item of playlist) {
        const start = elapsed;
        const end = start + item.duration;
        if (loopedSec >= start && loopedSec < end) {
          selected = item;
          offset = loopedSec - start;
          break;
        }
        elapsed = end;
      }

      if (!selected) {
        document.getElementById("now-playing").textContent += " â€” Off Air";
        return;
      }

      // Prevent reloading same URL unnecessarily
      if (selected.url === currentUrl && Math.abs(video.currentTime - offset) < 10) return;

      currentUrl = selected.url;

      if (hls) hls.destroy();
      hls = new Hls();
      hls.loadSource(selected.url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.currentTime = offset;
        video.muted = !unmuted;
        video.play();
      });
    }

    speaker.addEventListener("click", () => {
      unmuted = true;
      video.muted = false;
      speaker.classList.add("unmuted");
    });

    loadSchedule();
    setInterval(loadSchedule, 60000); // update every 1 min
  </script>
</body>
</html>
