<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MSTV Live Channel</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }
    #player-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: auto;
      background: #000;
    }
    video {
      width: 100%;
      height: auto;
      background: #000;
    }
    #speaker-icon {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
    }
    #speaker-icon img {
      width: 24px;
      height: 24px;
    }
  </style>
</head>
<body>
  <h2>MSTV Live Channel</h2>
  <div id="player-container">
    <video id="video" playsinline muted></video>
    <div id="speaker-icon">
      <img id="speaker-img" src="https://img.icons8.com/ios-filled/50/ffffff/mute.png" alt="Speaker Icon" />
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('video');
    const speakerIcon = document.getElementById('speaker-icon');
    const speakerImg = document.getElementById('speaker-img');
    let hls;
    let isMuted = true;
    let currentVolume = localStorage.getItem("volume") || "muted";

    const channelIndex = parseInt(new URLSearchParams(location.search).get("ch") || "1") - 1;
    const SCHEDULE_URL = "https://raw.githubusercontent.com/mstvnetwork/mstv2/main/schedule.json";

    function toggleMute() {
      isMuted = !isMuted;
      video.muted = isMuted;
      localStorage.setItem("volume", isMuted ? "muted" : "unmuted");
      speakerImg.src = isMuted
        ? "https://img.icons8.com/ios-filled/50/ffffff/mute.png"
        : "https://img.icons8.com/ios-filled/50/ffffff/speaker.png";
    }

    speakerIcon.addEventListener("click", () => {
      toggleMute();
      if (!video.paused) return;
      video.play();
    });

    async function fetchSchedule() {
      const res = await fetch(SCHEDULE_URL);
      const data = await res.json();
      return data[channelIndex]?.playlist || [];
    }

    function getCurrentItem(playlist) {
      const now = new Date();
      const secondsInDay = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      let total = 0;
      for (let i = 0; i < playlist.length; i++) {
        total += parseInt(playlist[i].duration);
      }
      const loopTime = secondsInDay % total;

      let sum = 0;
      for (let i = 0; i < playlist.length; i++) {
        const item = playlist[i];
        const start = sum;
        const end = sum + parseInt(item.duration);
        if (loopTime >= start && loopTime < end) {
          return {
            ...item,
            startTimeOffset: loopTime - start
          };
        }
        sum += parseInt(item.duration);
      }
      return null;
    }

    function resetVideoElement() {
      const newVideo = video.cloneNode(true);
      video.parentNode.replaceChild(newVideo, video);
      return newVideo;
    }

    async function playCurrentVideo() {
      const playlist = await fetchSchedule();
      const current = getCurrentItem(playlist);
      if (!current) {
        console.error("No valid schedule item.");
        return;
      }

      const newVideo = resetVideoElement();
      newVideo.muted = currentVolume === "muted";
      speakerImg.src = currentVolume === "muted"
        ? "https://img.icons8.com/ios-filled/50/ffffff/mute.png"
        : "https://img.icons8.com/ios-filled/50/ffffff/speaker.png";

      if (Hls.isSupported()) {
        hls = new Hls({ startPosition: current.startTimeOffset });
        hls.loadSource(current.url);
        hls.attachMedia(newVideo);

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          newVideo.currentTime = current.startTimeOffset;
          newVideo.play().catch(() => {});
        });

        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            hls.destroy();
            setTimeout(playCurrentVideo, 2000);
          }
        });
      } else if (newVideo.canPlayType("application/vnd.apple.mpegurl")) {
        newVideo.src = current.url;
        newVideo.addEventListener("loadedmetadata", () => {
          newVideo.currentTime = current.startTimeOffset;
          newVideo.play().catch(() => {});
        });
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      currentVolume = localStorage.getItem("volume") || "muted";
      isMuted = currentVolume === "muted";
      playCurrentVideo();
    });
  </script>
</body>
</html>
