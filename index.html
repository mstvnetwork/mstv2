<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSTV LIVE | Robotic Sync</title>
    <style>
        :root { --accent: #ff0000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #player-wrap { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .brand { position: absolute; top: 20px; right: 20px; text-align: right; z-index: 10; opacity: 0.8; }
        .brand-name { color: white; font-weight: 900; font-size: 20px; }
        .live-tag { background: var(--accent); color: white; font-size: 10px; padding: 2px 5px; border-radius: 2px; }
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; visibility: hidden; }
        #overlay.active { visibility: visible; }
        #play-btn { background: var(--accent); border: none; color: white; padding: 15px 30px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="player-wrap">
    <div class="brand"><div class="brand-name">MSTV</div><div class="live-tag">LIVE</div></div>
    <div id="overlay">
        <div id="status-msg">LOADING CHANNEL...</div>
        <button id="play-btn" onclick="startPlayer()">CLICK TO SYNC LIVE</button>
    </div>
    <video id="main-video" playsinline muted autoplay></video>
</div>

<script>
// --- 1. SPA REDIRECT DECODER ---
(function(l) {
  if (l.search[1] === 'p' && l.search[2] === '=') {
    var query = l.search.slice(3).replace(/~and~/g, '&');
    var path = query.split('?')[0];
    window.history.replaceState(null, null, l.pathname.slice(0, l.pathname.lastIndexOf('/') + 1) + path.slice(1) + l.hash);
  }
}(window.location));

const video = document.getElementById('main-video');
const overlay = document.getElementById('overlay');
const statusMsg = document.getElementById('status-msg');
let playlistData = null;

// --- 2. GET CHANNEL ---
function getChannel() {
    const parts = window.location.pathname.split('/').filter(p => p && p !== 'mstv2');
    return parts.length > 0 ? parts[parts.length - 1] : 'ch1';
}

// --- 3. FETCH DATA ---
async function init() {
    const ch = getChannel();
    const repoURL = "https://mstvnetwork.github.io";
    try {
        // Absolute URL prevents 'Offline' errors caused by virtual folders
        const res = await fetch(`${repoURL}/${ch}.json?v=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error("JSON 404");
        playlistData = await res.json();
        sync();
    } catch (e) {
        statusMsg.innerText = "OFFLINE: " + ch;
        overlay.classList.add('active');
    }
}

function sync() {
    if (!playlistData) return;
    const p = playlistData.channels;
    const total = p.playlist.reduce((acc, item) => acc + item.duration, 0);
    const elapsed = (Date.now() - new Date(p.start_iso).getTime()) / 1000;
    const pos = elapsed % total;

    let acc = 0;
    let active = p.playlist[0];
    for (const item of p.playlist) {
        if (pos < (acc + item.duration)) { active = item; break; }
        acc += item.duration;
    }

    const seek = pos - acc;
    if (video.src !== active.url) {
        video.src = active.url;
        video.currentTime = seek;
        video.play().catch(() => {
            statusMsg.innerText = "READY: " + active.title;
            overlay.classList.add('active');
        });
    }
    if (Math.abs(video.currentTime - seek) > 1.2) video.currentTime = seek;
}

function startPlayer() {
    overlay.classList.remove('active');
    video.play();
}

setInterval(sync, 1000);
init();
</script>
</body>
</html>
