<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MSTV Global Sync Player</title>
  <style>
    body {
      margin: 0;
      background: black;
      font-family: sans-serif;
    }
    #player-wrapper {
      position: relative;
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16 / 9;
      background: black;
      overflow: hidden;
    }
    video, iframe {
      position: absolute;
      width: 100%;
      height: 100%;
      display: none;
      border: none;
    }
    #spinner {
      position: absolute;
      top: 50%; left: 50%;
      width: 60px; height: 60px;
      margin: -30px 0 0 -30px;
      border: 6px solid #ccc;
      border-top-color: gold;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #muteToggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      background: rgba(0,0,0,0.4);
      border-radius: 5px;
      padding: 5px;
      cursor: pointer;
      color: white;
      z-index: 10;
    }
    #banner {
      background: royalblue;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      position: absolute;
      bottom: 0;
      width: 100%;
    }
    #banner span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 20s linear infinite;
    }
    @keyframes scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-100%); }
    }
  </style>
</head>
<body>

<div id="player-wrapper">
  <video id="videoEl" autoplay playsinline muted></video>
  <iframe id="iframeEl" allow="autoplay" allowfullscreen></iframe>
  <div id="spinner"></div>
  <div id="muteToggle">ðŸ”‡</div>
  <div id="banner"><span>Loading playlist...</span></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const videoEl = document.getElementById('videoEl');
const iframeEl = document.getElementById('iframeEl');
const spinner = document.getElementById('spinner');
const muteToggle = document.getElementById('muteToggle');
const banner = document.querySelector('#banner span');

let videoList = [];
let startTimeUnix = 0;
let currentIndex = 0;
let hls = null;
let isMuted = true;
let cumulativeDurations = [];

function getJsonUrl() {
  const ch = new URLSearchParams(location.search).get('ch') || '1';
  return `https://raw.githubusercontent.com/mstvnetwork/mstv2/main/sync-ch${ch}.json`;
}

function showSpinner() {
  spinner.style.display = 'block';
}
function hideSpinner() {
  spinner.style.display = 'none';
}

function updateMuteIcon() {
  muteToggle.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
  videoEl.muted = isMuted;
}
muteToggle.onclick = () => {
  isMuted = !isMuted;
  localStorage.setItem('mstv-muted', isMuted ? '1' : '0');
  updateMuteIcon();
};

function playCurrentVideo() {
  const now = Math.floor(Date.now() / 1000);
  const videoStart = startTimeUnix + cumulativeDurations[currentIndex];
  const offset = now - videoStart;
  const vid = videoList[currentIndex];

  // Stop and reset all
  videoEl.pause();
  iframeEl.src = "";
  iframeEl.style.display = "none";
  videoEl.style.display = "none";
  if (hls) {
    hls.destroy();
    hls = null;
  }

  showSpinner();

  if (vid.type === 'iframe') {
    iframeEl.src = vid.url;
    iframeEl.style.display = "block";
    hideSpinner();
  } else {
    videoEl.style.display = "block";
    hls = new Hls();
    hls.loadSource(vid.url);
    hls.attachMedia(videoEl);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      videoEl.currentTime = Math.max(0, offset);
      videoEl.play().then(hideSpinner).catch(console.error);
    });
  }

  // Update banner
  let bannerText = `Now Playing: ${vid.title}`;
  if (videoList[currentIndex + 1]) {
    bannerText += ` | Next: ${videoList[currentIndex + 1].title}`;
  }
  banner.textContent = bannerText;
}

function tick() {
  const now = Math.floor(Date.now() / 1000);
  const elapsed = now - startTimeUnix;

  let index = 0;
  let sum = 0;
  for (let i = 0; i < videoList.length; i++) {
    sum += videoList[i].duration_seconds;
    if (elapsed < sum) {
      index = i;
      break;
    }
  }
  if (index !== currentIndex) {
    currentIndex = index;
    playCurrentVideo();
  }
}

function startPlayer(json) {
  videoList = json.video_list;
  startTimeUnix = Math.floor(Date.parse(json.start_time_utc) / 1000);
  cumulativeDurations = videoList.map((v, i) =>
    videoList.slice(0, i).reduce((sum, v) => sum + v.duration_seconds, 0)
  );

  // Load muted state
  isMuted = localStorage.getItem('mstv-muted') !== '0';
  updateMuteIcon();

  currentIndex = 0;
  playCurrentVideo();
  setInterval(tick, 5000);
}

fetch(getJsonUrl())
  .then(res => res.json())
  .then(startPlayer)
  .catch(err => {
    banner.textContent = 'Failed to load playlist';
    console.error(err);
  });
</script>

</body>
</html>
