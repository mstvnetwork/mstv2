<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSTV LIVE | Robotic Sync</title>
    <style>
        :root { --accent: #ff0000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: sans-serif; overflow: hidden; }
        #player-wrap { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .brand { position: absolute; top: 20px; right: 20px; z-index: 10; opacity: 0.8; text-align: right; }
        .brand-name { color: white; font-weight: 900; font-size: 20px; }
        .live-tag { background: var(--accent); color: white; font-size: 10px; padding: 2px 5px; border-radius: 2px; }
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; display: none; }
        #overlay.active { display: flex; }
        #play-btn { background: var(--accent); border: none; color: white; padding: 15px 30px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="player-wrap">
    <div class="brand"><div class="brand-name">MSTV</div><div class="live-tag">LIVE</div></div>
    <div id="overlay">
        <div id="status-msg">LOADING SYNC...</div>
        <button id="play-btn" onclick="startPlayer()">CLICK TO SYNC LIVE</button>
    </div>
    <video id="main-video" playsinline muted autoplay></video>
</div>

<script>
// --- 1. SPA REDIRECT RECOVERY ---
(function(l) {
  if (l.search[1] === '/' ) {
    var decoded = l.search.slice(1).split('&').map(function(s) { 
      return s.replace(/~and~/g, '&') 
    }).join('?');
    window.history.replaceState(null, null, l.pathname.slice(0, l.pathname.lastIndexOf('/') + 1) + decoded.slice(1) + l.hash);
  }
}(window.location));

const video = document.getElementById('main-video');
const overlay = document.getElementById('overlay');
const statusMsg = document.getElementById('status-msg');
let playlistData = null;

// --- 2. GET CHANNEL ID ---
function getChannel() {
    // Splits the URL and finds the last word (e.g., ch1)
    const path = window.location.pathname;
    const parts = path.split('/').filter(p => p && p !== 'mstv2');
    return parts.length > 0 ? parts[parts.length - 1].toLowerCase() : 'ch1';
}

// --- 3. FETCH AND SYNC ---
async function init() {
    const ch = getChannel();
    console.log("Syncing Channel:", ch);
    
    try {
        // Use a direct root-relative path to find the JSON
        const response = await fetch(`/mstv2/${ch}.json?v=${Date.now()}`, { cache: "no-store" });
        
        if (!response.ok) throw new Error("JSON Not Found");
        
        playlistData = await response.json();
        sync();
    } catch (e) {
        console.error(e);
        statusMsg.innerText = "OFFLINE: " + ch.toUpperCase();
        overlay.classList.add('active');
    }
}

function sync() {
    if (!playlistData) return;
    const p = playlistData.channels;
    const total = p.playlist.reduce((acc, item) => acc + item.duration, 0);
    const elapsed = (Date.now() - new Date(p.start_iso).getTime()) / 1000;
    const pos = elapsed % total;

    let acc = 0;
    let active = p.playlist[0];
    for (const item of p.playlist) {
        if (pos < (acc + item.duration)) {
            active = item;
            break;
        }
        acc += item.duration;
    }

    const seek = pos - acc;
    if (video.src !== active.url) {
        video.src = active.url;
        video.currentTime = seek;
        video.play().catch(() => {
            statusMsg.innerText = "READY: " + (active.title || "LIVE");
            overlay.classList.add('active');
        });
    }
    
    // Correction if out of sync by more than 1.5 seconds
    if (Math.abs(video.currentTime - seek) > 1.5) {
        video.currentTime = seek;
    }
}

function startPlayer() {
    overlay.classList.remove('active');
    video.play();
}

// Check sync every second
setInterval(sync, 1000);
// Reload playlist data every 5 minutes
setInterval(init, 300000);

init();
</script>
</body>
</html>
