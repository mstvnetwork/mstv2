<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MSTV Global Sync Player</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }
    #video-player, #video-iframe {
      width: 100%;
      max-height: 70vh;
    }
    #video-iframe {
      border: none;
    }
    #title-banner {
      background: #007bff;
      padding: 8px;
      font-size: 1.1em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>

  <div id="title-banner">Loading...</div>
  <video id="video-player" controls autoplay muted playsinline style="display:none;"></video>
  <iframe id="video-iframe" allow="autoplay; fullscreen" allowfullscreen style="display:none;" height="360"></iframe>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    function getJsonUrl() {
      const ch = new URLSearchParams(location.search).get('ch') || '1';
      return `https://raw.githubusercontent.com/mstvnetwork/mstv2/main/sync-ch${ch}.json`;
    }

    fetch(getJsonUrl())
      .then(res => res.json())
      .then(data => {
        const startTime = new Date(data.start_time_utc).getTime();
        const videoList = data.video_list;
        const now = Date.now();
        let elapsed = Math.floor((now - startTime) / 1000);

        const totalDuration = videoList.reduce((sum, v) => sum + v.duration_seconds, 0);
        elapsed %= totalDuration;

        let currentIndex = 0;
        let accumulated = 0;

        for (let i = 0; i < videoList.length; i++) {
          if (elapsed < accumulated + videoList[i].duration_seconds) {
            currentIndex = i;
            elapsed -= accumulated;
            break;
          }
          accumulated += videoList[i].duration_seconds;
        }

        playFromIndex(currentIndex, elapsed);

        function playFromIndex(index, offset) {
          const item = videoList[index];
          const remaining = item.duration_seconds - offset;

          document.getElementById("title-banner").innerText = item.title;

          if (item.type === "iframe") {
            playIframe(item.url);
          } else {
            playHLS(item.url, offset);
          }

          setTimeout(() => {
            const nextIndex = (index + 1) % videoList.length;
            playFromIndex(nextIndex, 0);
          }, remaining * 1000);
        }

        function playIframe(url) {
          const iframe = document.getElementById('video-iframe');
          const video = document.getElementById('video-player');
          if (video) video.pause();

          video.style.display = 'none';
          iframe.style.display = 'block';
          iframe.src = url;
        }

        function playHLS(url, offsetSeconds) {
          const video = document.getElementById('video-player');
          const iframe = document.getElementById('video-iframe');
          iframe.style.display = 'none';
          iframe.src = '';

          video.style.display = 'block';

          if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
              video.currentTime = offsetSeconds;
              video.play().catch(() => {
                video.muted = true;
                video.play();
              });
            });
          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.currentTime = offsetSeconds;
            video.play().catch(() => {
              video.muted = true;
              video.play();
            });
          }
        }
      });
  </script>
</body>
</html>
