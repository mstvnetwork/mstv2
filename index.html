<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Sync Dailymotion Player</title>
    <style>
        body {
            font-family: sans-serif;
            background: #000;
            color: white;
            margin: 0;
            text-align: center;
            overflow: hidden; /* Prevent scrollbars from player aspect ratio */
        }
        #player-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
        }
        #dailymotion-player {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: none;
            display: none; /* Hidden by default, JS will show */
            pointer-events: none; /* Crucial for overlaid controls */
            background-color: #000; /* Black background to avoid white flash */
        }
        #mute-toggle {
            position: absolute;
            top: 8px; right: 8px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            padding: 6px;
            user-select: none;
            pointer-events: all; /* Allow clicks on the toggle */
        }
        #scrolling-banner {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #007BFF;
            color: white;
            font-size: clamp(14px, 3vw, 20px);
            font-weight: bold;
            font-family: monospace;
            overflow: hidden;
            user-select: none;
            z-index: 10;
            pointer-events: none; /* Do not block player behind it */
            padding: 8px 0;
        }
        #marquee-text {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: marquee 15s linear infinite; /* Adjusted for continuous loop */
        }
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 215, 0, 0.2);
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
            box-shadow: 0 0 10px #FFD70088;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #loading-text {
            color: #FFD700;
            font-size: 20px;
            font-weight: 600;
            font-family: "Courier New", monospace;
            text-shadow: 0 0 6px #FFD70099;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

  <div id="player-container">
    <iframe id="dailymotion-player" allow="autoplay; fullscreen; picture-in-picture" referrerpolicy="strict-origin-when-cross-origin"></iframe>
    <div id="mute-toggle">ðŸ”‡</div>
    <div id="scrolling-banner">
      <div id="marquee-text">Loading...</div>
    </div>
  </div>

  <div id="loading-overlay">
    <div id="loading-spinner"></div>
    <div id="loading-text">Stream Loading...</div>
  </div>

  <script src="//api.dmcdn.net/all.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Configuration ---
        function getChannelFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const ch = params.get('ch');
            return ch ? ch : '1';
        }
        const ch = getChannelFromUrl();
        // ADJUSTED JSON URL for your mstv2 repo and filename
        const jsonUrl = `https://raw.githubusercontent.com/mstvnetwork/mstv2/main/sync-ch${ch}.json`;

        // --- Global Variables ---
        let dailymotionPlayer = document.getElementById('dailymotion-player');
        let loadingOverlay = document.getElementById('loading-overlay');
        let loadingText = document.getElementById('loading-text');
        let muteToggle = document.getElementById('mute-toggle');
        let marqueeText = document.getElementById('marquee-text');

        let dmPlayerAPI = null; // Variable to hold the Dailymotion API player object

        let currentPlaylist = [];
        let startTimeUTC = null;
        let currentVideoIndex = 0;
        let startSeconds = 0; // This will be the seek time for the current video
        let failSafeTimeout;
        let resyncInterval;

        const MUTE_KEY = 'globalPlayerMuted';
        // Initialize isMuted based on sessionStorage
        let isMuted = sessionStorage.getItem(MUTE_KEY) === 'false' ? false : true;

        // --- Helper Functions ---

        function showLoadingOverlay(text = 'Stream Loading...') {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            loadingOverlay.style.display = 'none';
        }

        function hidePlayer() {
            dailymotionPlayer.style.display = 'none';
            // Stop current video if API is active
            if (dmPlayerAPI) {
                dmPlayerAPI.pause(); // Pause video
                dmPlayerAPI = null; // Clear API instance
            }
            dailymotionPlayer.src = 'about:blank'; // Clear iframe source to prevent residual audio/video
        }

        function updateBanner(title = '') {
            marqueeText.textContent = title ? `Now Playing: ${title}` : 'Loading Channel Schedule...';
            marqueeText.style.animation = 'none';
            marqueeText.offsetHeight; // Trigger reflow
            marqueeText.style.animation = null;
        }

        function updateMuteToggleIcon() {
            muteToggle.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
        }

        // --- Fail-Safe for Loading ---
        function setFailSafe() {
            clearTimeout(failSafeTimeout);
            failSafeTimeout = setTimeout(() => {
                console.warn("Video failed to load or play within 10 seconds. Skipping...");
                advanceToNextItem();
            }, 10000); // 10 seconds
        }

        function clearFailSafe() {
            clearTimeout(failSafeTimeout);
        }

        // --- Player Core Logic ---

        function calculateCurrentPosition() {
            if (!startTimeUTC || currentPlaylist.length === 0) {
                console.warn("calculateCurrentPosition: No startTimeUTC or empty playlist.");
                return { index: 0, time: 0, video: null };
            }

            const now = Date.now();
            console.log("calculateCurrentPosition: Current Local Time (ms):", now, " | Date:", new Date(now).toISOString());
            console.log("calculateCurrentPosition: Start Time UTC (ms):", startTimeUTC, " | Date:", new Date(startTimeUTC).toISOString());

            const elapsedSeconds = Math.floor((now - startTimeUTC) / 1000);
            console.log("calculateCurrentPosition: Elapsed Seconds since start_time_utc:", elapsedSeconds);

            let totalDuration = 0;
            for (const video of currentPlaylist) {
                totalDuration += video.duration_seconds;
            }
            console.log("calculateCurrentPosition: Total Playlist Duration (seconds):", totalDuration);

            if (totalDuration === 0) {
                console.warn("calculateCurrentPosition: Total playlist duration is 0. Returning first item.");
                return { index: 0, time: 0, video: currentPlaylist[0] || null };
            }

            // Ensure elapsedSeconds is always positive for modulo calculation
            // This handles cases where start_time_utc might be slightly in the future
            const positiveElapsedSeconds = elapsedSeconds < 0 ? totalDuration - (Math.abs(elapsedSeconds) % totalDuration) : elapsedSeconds;
            const loopedElapsed = positiveElapsedSeconds % totalDuration;
            console.log("calculateCurrentPosition: Looped Elapsed Seconds (modulo total duration):", loopedElapsed);

            let accumulated = 0;
            for (let i = 0; i < currentPlaylist.length; i++) {
                const video = currentPlaylist[i];
                if (loopedElapsed < accumulated + video.duration_seconds) {
                    const calculatedTime = loopedElapsed - accumulated;
                    console.log(`calculateCurrentPosition: Calculated Index: ${i}, Calculated Time in video: ${calculatedTime}`);
                    return {
                        index: i,
                        time: calculatedTime,
                        video: video
                    };
                }
                accumulated += video.duration_seconds;
            }
            console.warn("calculateCurrentPosition: Could not find current video in playlist based on time. This should not happen with proper modulo logic. Returning first item.");
            return { index: 0, time: 0, video: currentPlaylist[0] || null };
        }

        function advanceToNextItem() {
            console.log("Advancing to next item, recalculating global position...");
            syncAndPlay();
        }

        // Function to extract Dailymotion video ID from various URL formats
        function getDailymotionVideoId(url) {
            const regex = /(?:dailymotion\.com\/(?:video|embed\/video)\/|dai\.ly\/)([a-zA-Z0-9]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        async function loadDailymotionVideo(videoItem, seekTime = 0) {
            hidePlayer(); // Hide and clear current player
            showLoadingOverlay(`Loading: ${videoItem.title}`);
            clearFailSafe();

            dailymotionPlayer.style.display = 'block';
            dailymotionPlayer.id = 'dailymotion-player'; // Ensure iframe has this ID

            const videoId = getDailymotionVideoId(videoItem.url);
            if (!videoId) {
                console.error("Invalid Dailymotion video URL:", videoItem.url);
                updateBanner("Error: Invalid Dailymotion URL.");
                advanceToNextItem();
                return;
            }

            // Initialize Dailymotion API player
            // dmAsyncInit is called by the Dailymotion API script when it loads.
            // If it's already loaded, we might need to call DM.player directly.
            // This pattern handles both scenarios.
            if (typeof DM !== 'undefined' && DM.player) {
                 initDailymotionPlayer(videoId, seekTime, videoItem.title);
            } else {
                window.dmAsyncInit = function() {
                    initDailymotionPlayer(videoId, seekTime, videoItem.title);
                };
            }
        }

        function initDailymotionPlayer(videoId, seekTime, videoTitle) {
            if (dmPlayerAPI) {
                // If an API instance exists, destroy it cleanly before creating a new one
                // dmPlayerAPI.destroy(); // Dailymotion API often handles this by reusing the element.
                // Resetting dmPlayerAPI to null might be safer if not destroying.
                dmPlayerAPI = null;
            }

            dmPlayerAPI = DM.player(dailymotionPlayer, { // Target the iframe element
                video: videoId,
                width: '100%',
                height: '100%',
                params: {
                    autoplay: true,
                    muted: isMuted,
                    start: Math.floor(seekTime),
                    // Optional: remove controls, info, branding
                    controls: false, // Hide DM's controls
                    info: false, // Hide video info overlay
                    logo: false, // Hide DM logo
                    'sharing-enable': false,
                    'fullscreen-action': 'trigger_event' // Allows better handling
                },
                events: {
                    apiready: function() {
                        console.log('Dailymotion API ready for video:', videoTitle);
                        // Ensure mute state is applied
                        dmPlayerAPI.setMuted(isMuted);
                        // Start playing. Browser might still block until user interaction.
                        dmPlayerAPI.play().then(() => {
                            hideLoadingOverlay();
                            setFailSafe(); // Set fail-safe. If play() is successful, expect events.
                        }).catch(error => {
                            console.error('Dailymotion API play() failed:', error);
                            hideLoadingOverlay();
                            alert('Could not auto-play Dailymotion video. User interaction may be required.');
                            setFailSafe(); // Fail-safe to advance if auto-play is blocked
                        });
                    },
                    play: function() {
                        console.log('Dailymotion video started playing.');
                        clearFailSafe(); // Video is playing, clear fail-safe
                    },
                    end: function() {
                        console.log('Dailymotion video ended. Recalculating next scheduled item...');
                        advanceToNextItem();
                    },
                    error: function(e) {
                        console.error('Dailymotion API Error:', e.data);
                        hideLoadingOverlay();
                        alert('Dailymotion playback error: ' + (e.data.error ? e.data.error.message : 'Unknown error'));
                        advanceToNextItem(); // Skip to next video on error
                    }
                }
            });
        }


        // --- Main Sync Function ---
        function syncAndPlay() {
            const { index, time, video } = calculateCurrentPosition();

            if (!video) {
                updateBanner('No content available. Check playlist.');
                hideLoadingOverlay();
                hidePlayer();
                return;
            }

            const needsVideoChange = currentVideoIndex !== index;
            // For Dailymotion API, we want to reload if video changes, or if current time drift is too large
            // and the video is not playing/buffering (which the API can handle).
            // Simplest for now: always reload if video changes. For existing video, API should keep playing.
            // If the video is the same, we trust the API to be playing.
            const needsSeekReload = false; // We won't force a reload just for seeking if API is working.

            console.log(`Sync Check: Index=${index}, Time=${time.toFixed(1)}s, Title=${video.title}`);
            console.log(`Needs Video Change: ${needsVideoChange}, Needs Seek Reload (ignored for API): ${needsSeekReload}`);


            if (needsVideoChange) { // Only load the video if the video itself changes
                currentVideoIndex = index;
                startSeconds = time; // Update global startSeconds for next load
                updateBanner(video.title);
                loadDailymotionVideo(video, startSeconds);
            } else {
                // If the same video, and not needing a seek reload, just ensure the overlay is hidden
                // and clear any pending fail-safe.
                hideLoadingOverlay();
                clearFailSafe();

                // If we're on the same video, and API is ready, try to ensure play state and seek
                // This is where API's direct control shines.
                if (dmPlayerAPI) {
                    dmPlayerAPI.isPaused().then(paused => {
                        if (paused) {
                            console.log("DM API: Player was paused, attempting to play.");
                            dmPlayerAPI.play().catch(e => console.warn("DM API: Failed to play on resync:", e));
                        }
                    });
                    // Dailymotion API has a seek method, but it can be slow for live sync.
                    // The initial 'start' parameter is most reliable for global sync.
                    // dmPlayerAPI.setCurrentTime(time); // Not always smooth, relies on video being loaded.
                }
            }
        }

        // --- Event Listeners & Initializers ---

        muteToggle.addEventListener('click', () => {
            isMuted = !isMuted;
            updateMuteToggleIcon();
            sessionStorage.setItem(MUTE_KEY, isMuted);

            if (dmPlayerAPI) {
                dmPlayerAPI.setMuted(isMuted).then(() => {
                    console.log("Dailymotion player mute state set to:", isMuted);
                }).catch(e => console.error("Failed to set Dailymotion mute state:", e));
                clearFailSafe(); // Mute toggle counts as interaction, clear fail-safe.
            } else {
                // Fallback: if API not ready, reload iframe with new mute state
                const currentVideoItem = currentPlaylist[currentVideoIndex];
                if (currentVideoItem) {
                    loadDailymotionVideo(currentVideoItem, startSeconds);
                }
            }
        });

        // Initialize the mute icon correctly on page load based on persisted state
        updateMuteToggleIcon();

        async function initializePlayer() {
            showLoadingOverlay('Fetching Channel Schedule...');
            try {
                const res = await fetch(jsonUrl);
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status} for ${jsonUrl}`);
                }
                const data = await res.json();
                currentPlaylist = data.video_list || [];
                startTimeUTC = new Date(data.start_time_utc).getTime();

                if (isNaN(startTimeUTC)) {
                    throw new Error("Invalid start_time_utc in playlist JSON.");
                }

                console.log('Playlist loaded:', currentPlaylist);
                console.log('Start Time (UTC):', new Date(startTimeUTC).toISOString());

                syncAndPlay(); // Initial sync to determine what to play now

                // Set up periodic re-sync (e.g., every 15 seconds)
                clearInterval(resyncInterval); // Clear any previous interval
                resyncInterval = setInterval(() => {
                    console.log('Periodic resync triggered.');
                    syncAndPlay();
                }, 15000); // Resync every 15 seconds for iframes (can be longer than HLS)
            } catch (e) {
                console.error('Failed to initialize player:', e);
                updateBanner('Error loading channel. Check console.');
                hideLoadingOverlay();
                alert('Error loading channel: ' + e.message + '. Please check console.');
            }
        }

        initializePlayer();
    });
</script>
</body>
</html>
