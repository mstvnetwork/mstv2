<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MSTV LIVE | Robotic Sync</title>
    <style>
        :root { --accent: #ff0000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #player-wrap { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; pointer-events: none; }
        .brand { position: absolute; top: 30px; right: 30px; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; opacity: 0.8; z-index: 10; }
        .brand-name { color: white; font-weight: 900; font-size: 24px; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .live-tag { background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; font-weight: bold; border-radius: 2px; }
        #status-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 40; opacity: 0; visibility: hidden; transition: 0.3s; }
        #status-overlay.active { opacity: 1; visibility: visible; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #ui-layer { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; opacity: 0; transition: 0.4s; z-index: 50; }
        #ui-layer.visible { opacity: 1; }
        .ctrl-btn { background: rgba(30,30,30,0.85); border: 1px solid rgba(255,255,255,0.2); color: white; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; backdrop-filter: blur(5px); }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="player-wrap">
    <div class="brand"><div class="brand-name">MSTV</div><div class="live-tag">LIVE</div></div>
    <div id="status-overlay"><div class="spinner"></div><div id="status-text" style="color:white; font-weight:bold; font-size:12px; letter-spacing:1px;">SYNCING LIVE STREAM...</div></div>
    <video id="main-video" playsinline muted autoplay preload="auto"></video>
    <div id="ui-layer">
        <button class="ctrl-btn" id="mute-toggle">ðŸ”‡</button>
        <button class="ctrl-btn" id="fs-toggle">â›¶</button>
    </div>
</div>

<script>
/** 
 * 1. SPA REDIRECT RECOVERY
 * This part takes the /?p=/ch2 from the 404 redirect and 
 * physically rewrites the URL to /ch2 so the script can see it.
 */
(function(l) {
  if (l.search[1] === '/' ) {
    var decoded = l.search.slice(1).split('&').map(function(s) { 
      return s.replace(/~and~/g, '&') 
    }).filter(function(v) { return v.indexOf('=') === -1 })[0] || '';
    if (decoded !== l.pathname.slice(l.pathname.lastIndexOf('/') + 1)) {
      window.history.replaceState(null, null, 
        l.pathname.slice(0, l.pathname.lastIndexOf('/') + 1) + decoded.slice(1) + l.hash
      );
    }
  }
}(window.location));

const video = document.getElementById('main-video');
const uiLayer = document.getElementById('ui-layer');
const statusOverlay = document.getElementById('status-overlay');
const muteBtn = document.getElementById('mute-toggle');
const fsBtn = document.getElementById('fs-toggle');
let playlistData = null;
let uiTimer;

/** 
 * 2. CHANNEL DETECTOR 
 * Calibrated specifically for 'mstv2' repository
 */
function getChannelID() {
    const path = window.location.pathname;
    const parts = path.split('/').filter(p => p && p !== 'mstv2');
    const channel = parts.length > 0 ? parts[parts.length - 1] : 'ch1';
    console.log("Player Initialized on Channel:", channel);
    return channel.toLowerCase();
}

/** 
 * 3. FETCH AND SYNC LOGIC
 */
async function fetchAndSync() {
    const channelId = getChannelID();
    try {
        // Use full URL to bypass relative path issues on virtual directories
        const jsonUrl = `https://mstvnetwork.github.io{channelId}.json?v=${Date.now()}`;
        const response = await fetch(jsonUrl, { cache: "no-store" });
        
        if (!response.ok) throw new Error("JSON file not found: " + channelId);
        
        playlistData = await response.json();
        calculateLiveState();
    } catch (e) {
        console.error("Fetch Error:", e);
        document.getElementById('status-text').innerText = "CHANNEL OFFLINE";
    }
}

function calculateLiveState() {
    if (!playlistData || !playlistData.channels) return;
    
    const ch = playlistData.channels;
    const totalDuration = ch.playlist.reduce((acc, item) => acc + item.duration, 0);
    const startEpoch = new Date(ch.start_iso).getTime();
    const elapsedTotal = (Date.now() - startEpoch) / 1000;
    const currentLoopPos = elapsedTotal % totalDuration;

    let accumulated = 0;
    let activeItem = ch.playlist[0];

    for (const item of ch.playlist) {
        if (currentLoopPos < (accumulated + item.duration)) {
            activeItem = item;
            break;
        }
        accumulated += item.duration;
    }

    const targetTime = currentLoopPos - accumulated;

    // Switch Source
    if (video.src !== activeItem.url) {
        statusOverlay.classList.add('active');
        video.src = activeItem.url;
        video.currentTime = targetTime;
        video.play().catch(() => console.log("User interaction required for audio"));
    } 
    
    // Sync Correction
    const drift = Math.abs(video.currentTime - targetTime);
    if (drift > 1.0) video.currentTime = targetTime;
}

// 4. PLAYER EVENTS & UI
video.addEventListener('seeking', () => { if (playlistData) calculateLiveState(); });
setInterval(calculateLiveState, 1000);
setInterval(fetchAndSync, 60000);

function showUI() {
    uiLayer.classList.add('visible');
    clearTimeout(uiTimer);
    uiTimer = setTimeout(() => uiLayer.classList.remove('visible'), 3000);
}
document.addEventListener('mousemove', showUI);
document.addEventListener('touchstart', showUI);

muteBtn.onclick = () => {
    video.muted = !video.muted;
    muteBtn.innerText = video.muted ? "ðŸ”‡" : "ðŸ”Š";
};
fsBtn.onclick = () => {
    if (!document.fullscreenElement) document.getElementById('player-wrap').requestFullscreen();
    else document.exitFullscreen();
};

video.onplaying = () => statusOverlay.classList.remove('active');
video.onwaiting = () => statusOverlay.classList.add('active');

// Execute Initial Fetch
fetchAndSync();
</script>
</body>
</html>
