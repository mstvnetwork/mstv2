<!DOCTYPE html>
<html>
<head>
  <title>Global Synced M3U8 Player</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      overflow: hidden;
      font-family: sans-serif;
    }

    #player-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: auto;
      height: 360px;
      background: black;
    }

    video {
      width: 100%;
      height: 100%;
      background: black;
    }

    #mute-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 28px;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 6px;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      z-index: 10;
      user-select: none;
    }

    /* Hide default video controls like seek bar and timestamps */
    video::-webkit-media-controls {
      display: none !important;
    }

    video::-webkit-media-controls-enclosure {
      display: none !important;
    }
  </style>
</head>
<body>

<div id="player-container">
  <video id="video" autoplay muted playsinline></video>
  <div id="mute-toggle">ðŸ”‡</div>
</div>

<script>
  const video = document.getElementById("video");
  const muteToggle = document.getElementById("mute-toggle");
  let isMuted = true;

  // Set up mute toggle
  muteToggle.addEventListener("click", () => {
    if (isMuted) {
      video.muted = false;
      isMuted = false;
      muteToggle.innerText = "ðŸ”Š";
    } else {
      video.muted = true;
      isMuted = true;
      muteToggle.innerText = "ðŸ”‡";
    }
  });

  // JSON sync URL (adjust to your real channel file)
  const urlParams = new URLSearchParams(window.location.search);
  const channel = urlParams.get("ch") || "1";
  const JSON_URL = `https://raw.githubusercontent.com/mstvnetwork/mstv2/main/sync-ch${channel}.json`;

  let playlist = [], durations = [], startTimeUTC = 0;

  async function loadJSON() {
    try {
      const res = await fetch(JSON_URL);
      const data = await res.json();
      playlist = data.video_urls;
      startTimeUTC = new Date(data.start_time_utc).getTime();
      durations = Array(playlist.length).fill(600); // fallback to 10 min per stream
      syncAndPlay();
      setInterval(syncAndPlay, 60 * 1000); // live sync correction every minute
    } catch (err) {
      console.error("Failed to load sync data:", err);
    }
  }

  function syncAndPlay() {
    const now = Date.now();
    const elapsed = Math.floor((now - startTimeUTC) / 1000);
    const totalDuration = durations.reduce((a, b) => a + b, 0);

    let index = 0;
    let seconds = elapsed % totalDuration;
    let acc = 0;

    for (let i = 0; i < durations.length; i++) {
      if (seconds < acc + durations[i]) {
        index = i;
        break;
      }
      acc += durations[i];
    }

    if (video.src !== playlist[index]) {
      video.src = playlist[index];
      video.load();
      video.play().catch(err => console.warn("Autoplay failed:", err));
    }
  }

  loadJSON();
</script>
</body>
</html>
