<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Sync Player</title>
  <style>
    body { margin: 0; background: black; color: white; font-family: sans-serif; }
    #player-container { position: relative; width: 100%; max-width: 800px; margin: auto; background: black; }
    video, iframe { width: 100%; height: 450px; display: none; background: black; }
    #spinner {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      border: 6px solid #f3f3f3;
      border-top: 6px solid gold;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #banner {
      position: sticky;
      top: 0;
      background: #0033cc;
      color: white;
      padding: 5px 10px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
    }
    #banner span {
      display: inline-block;
      animation: scroll 10s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    #muteToggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      background: rgba(0, 0, 0, 0.4);
      padding: 5px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="banner"><span>Loading playlist...</span></div>
  <div id="player-container">
    <div id="muteToggle">ðŸ”‡</div>
    <video id="video" muted autoplay playsinline></video>
    <iframe id="iframe" frameborder="0" allowfullscreen allow="autoplay"></iframe>
    <div id="spinner"></div>
  </div>

  <script>
    const jsonUrl = 'playlist.json'; // Replace with your actual JSON URL
    const videoEl = document.getElementById('video');
    const iframeEl = document.getElementById('iframe');
    const spinner = document.getElementById('spinner');
    const banner = document.querySelector('#banner span');
    const muteToggle = document.getElementById('muteToggle');
    let videoList = [], startTimeUTC = null;

    fetch(jsonUrl)
      .then(res => res.json())
      .then(data => {
        videoList = data.video_list;
        startTimeUTC = new Date(data.start_time_utc);
        updateBanner();
        playCurrentSlot();
        setInterval(playCurrentSlot, 5000); // check every 5s
      });

    function updateBanner() {
      let bannerText = videoList.map((v, i) => `${i + 1}. ${v.title}`).join(' â€” ');
      banner.textContent = bannerText;
    }

    function getCurrentSlotIndex() {
      const now = new Date();
      let secondsPassed = Math.floor((now - startTimeUTC) / 1000);
      let total = 0;
      for (let i = 0; i < videoList.length; i++) {
        total += videoList[i].duration_seconds;
        if (secondsPassed < total) return i;
      }
      return 0;
    }

    function playCurrentSlot() {
      const index = getCurrentSlotIndex();
      const current = videoList[index];
      if (!current) return;

      banner.textContent = current.title;
      spinner.style.display = 'block';

      if (current.type === 'iframe') {
        videoEl.pause();
        videoEl.style.display = 'none';
        iframeEl.src = current.url;
        iframeEl.style.display = 'block';
        spinner.style.display = 'none'; // iframes load independently
      } else {
        iframeEl.style.display = 'none';
        iframeEl.src = '';
        videoEl.src = current.url;
        videoEl.currentTime = getCurrentPlaybackOffset(index);
        videoEl.play().catch(console.error);
        videoEl.style.display = 'block';
      }
    }

    function getCurrentPlaybackOffset(index) {
      const now = new Date();
      let elapsed = Math.floor((now - startTimeUTC) / 1000);
      let offset = elapsed;
      for (let i = 0; i < index; i++) {
        offset -= videoList[i].duration_seconds;
      }
      return Math.max(0, offset);
    }

    // Mute toggle
    muteToggle.onclick = () => {
      videoEl.muted = !videoEl.muted;
      muteToggle.textContent = videoEl.muted ? 'ðŸ”‡' : 'ðŸ”Š';
    };

    // Hide spinner when HLS is ready
    videoEl.addEventListener('canplay', () => spinner.style.display = 'none');
  </script>
</body>
</html>
