<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Global Sync Player</title>
  <style>
    body { margin: 0; background: black; color: white; font-family: sans-serif; }
    #player-container { position: relative; width: 100%; max-width: 100%; height: 100vh; background: black; display: flex; justify-content: center; align-items: center; }
    #video, #iframe-player { width: 100%; height: 100%; display: none; }
    #spinner { position: absolute; width: 50px; height: 50px; border: 6px solid #fff; border-top: 6px solid gold; border-radius: 50%; animation: spin 1s linear infinite; z-index: 5; }
    #mute-toggle { position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; z-index: 10; }
    #banner { position: absolute; bottom: 0; width: 100%; background: blue; white-space: nowrap; overflow: hidden; z-index: 10; }
    #scrolling-text { display: inline-block; padding-left: 100%; animation: scroll 20s linear infinite; }
    @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="player-container">
  <video id="video" muted autoplay playsinline></video>
  <iframe id="iframe-player" frameborder="0" allowfullscreen allow="autoplay"></iframe>
  <div id="spinner"></div>
  <div id="mute-toggle">ðŸ”‡</div>
  <div id="banner"><div id="scrolling-text"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const video = document.getElementById('video');
const iframe = document.getElementById('iframe-player');
const spinner = document.getElementById('spinner');
const muteToggle = document.getElementById('mute-toggle');
const banner = document.getElementById('scrolling-text');
let hls;

function getJsonUrl() {
  const ch = new URLSearchParams(location.search).get('ch') || '1';
  return `https://raw.githubusercontent.com/mstvnetwork/mstv2/main/sync-ch${ch}.json`;
}

async function fetchPlaylist() {
  const res = await fetch(getJsonUrl());
  return await res.json();
}

function getCurrentVideoIndex(startTime, videoList) {
  const now = Date.now();
  const start = Date.parse(startTime);
  let elapsed = Math.floor((now - start) / 1000);
  let total = 0;
  for (let i = 0; i < videoList.length; i++) {
    total += videoList[i].duration_seconds;
    if (elapsed < total) {
      return { index: i, offset: elapsed - (total - videoList[i].duration_seconds) };
    }
  }
  return { index: 0, offset: 0 };
}

function setBannerText(text) {
  banner.textContent = text;
}

function showSpinner(show) {
  spinner.style.display = show ? 'block' : 'none';
}

function stopVideoAndIframe() {
  if (hls) {
    hls.destroy();
    hls = null;
  }
  video.pause();
  video.src = '';
  iframe.src = '';
  video.style.display = 'none';
  iframe.style.display = 'none';
}

function playVideo(url, offset) {
  stopVideoAndIframe();
  showSpinner(true);
  video.style.display = 'block';

  if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, function () {
      video.currentTime = offset;
      video.play();
      showSpinner(false);
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = url;
    video.addEventListener('loadedmetadata', function () {
      video.currentTime = offset;
      video.play();
      showSpinner(false);
    });
  }
}

function playIframe(url) {
  stopVideoAndIframe();
  showSpinner(true);

  iframe.src = ''; // Reset properly before setting new src
  iframe.style.display = 'none'; // Hide first

  setTimeout(() => {
    iframe.src = url;
    iframe.style.display = 'block';
    showSpinner(false);
  }, 500); // Slight delay to ensure clean reload
}

function playSlot(videoObj, offset = 0) {
  setBannerText(videoObj.title + " | Starting at " + new Date().toUTCString());
  if (videoObj.type === 'iframe') {
    playIframe(videoObj.url);
  } else {
    playVideo(videoObj.url, offset);
  }
}

function startSyncPlayer() {
  fetchPlaylist().then(data => {
    const { index, offset } = getCurrentVideoIndex(data.start_time_utc, data.video_list);
    playSlot(data.video_list[index], offset);

    let current = index;
    setInterval(() => {
      const newNow = getCurrentVideoIndex(data.start_time_utc, data.video_list);
      if (newNow.index !== current) {
        current = newNow.index;
        playSlot(data.video_list[current], newNow.offset);
      }
    }, 10000);
  });
}

muteToggle.onclick = () => {
  video.muted = !video.muted;
  muteToggle.textContent = video.muted ? 'ðŸ”‡' : 'ðŸ”Š';
};

startSyncPlayer();
</script>

</body>
</html>
